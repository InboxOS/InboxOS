name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: pdo, pdo_mysql

    - name: Install dependencies
      working-directory: symfony-dashboard
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Run unit tests
      working-directory: symfony-dashboard
      run: ./vendor/bin/phpunit --testsuite=unit

    - name: Run integration tests
      working-directory: symfony-dashboard
      run: ./vendor/bin/phpunit --testsuite=integration

    - name: Run migration tests
      working-directory: symfony-dashboard
      run: ./vendor/bin/phpunit --testsuite=migrations

    - name: Check PHP syntax
      working-directory: symfony-dashboard
      run: find src -name "*.php" -exec php -l {} \;

  performance:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: pdo, pdo_mysql, curl

    - name: Install dependencies
      working-directory: symfony-dashboard
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Start test server
      working-directory: symfony-dashboard
      run: |
        php bin/console cache:clear
        php -S localhost:8000 -t public > /dev/null 2>&1 &
        sleep 5

    - name: Run load tests
      run: php scripts/load-test.php http://localhost:8000

    - name: Run security audit
      run: php scripts/security-audit.php http://localhost:8000

  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Validate docker-compose
      run: docker-compose config

    - name: Validate setup scripts
      run: |
        bash -n setup-complete.sh
        bash -n scripts/monitor.sh
        bash -n backup-scripts/backup.sh
        bash -n scripts/load-test.php
        bash -n scripts/security-audit.php
        bash -n scripts/production-readiness.sh

    - name: Check file permissions
      run: |
        find scripts -name "*.sh" -exec test -x {} \;
        find scripts -name "*.php" -exec test -x {} \;
        find backup-scripts -name "*.sh" -exec test -x {} \;