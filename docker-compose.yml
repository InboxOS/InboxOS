services:
  # Symfony Dashboard
  symfony-dashboard:
    build: ./symfony-dashboard
    image: localhost/email-server/dashboard:latest
    container_name: mail-dashboard
    restart: unless-stopped
    volumes:
      - ./data/dashboard/uploads:/var/www/html/public/uploads
      - ./data/dashboard/backups:/var/www/html/var/backups
      - ./certificates:/var/www/html/var/certificates
    environment:
      - DOCKER_HOST=tcp://socket-proxy:2375
      - DATABASE_URL=mysql://mailadmin:${MYSQL_PASSWORD}@mysql/${MYSQL_DATABASE}
      - MAIL_SERVER_HOST=mailserver
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - APP_ENV=prod
      - APP_SECRET=${APP_SECRET}
      - TWO_FACTOR_ISSUER=${TWO_FACTOR_ISSUER:-MailServer_Dashboard}
      - MAILER_DSN=smtp://mailserver:587
      # Public URL for the (optional) webmail UI.
      - HORDE_URL=${HORDE_URL}
      - VIRTUAL_HOST=${DOMAIN}
      - LETSENCRYPT_HOST=${LETSENCRYPT_HOST}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - DEFAULT_URI=${DEFAULT_URI:-http://localhost:8080}
      - MERCURE_URL=${MERCURE_URL:-http://localhost:3000/.well-known/mercure}
      - MERCURE_PUBLIC_URL=${MERCURE_PUBLIC_URL:-http://localhost:3000/.well-known/mercure}
      - MERCURE_JWT_SECRET=${MERCURE_JWT_SECRET:-!ChangeThisMercureHubJWTSecretKey!}
    networks:
      - mail-network
    depends_on:
      - mysql
      - redis
      - socket-proxy
    healthcheck:
      # This container runs php-fpm (no HTTP server inside), so check the process.
      test: ["CMD-SHELL", "pgrep -x php-fpm >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Socket Proxy (Security Layer)
  socket-proxy:
    image: docker.io/tecnativa/docker-socket-proxy
    container_name: mail-socket-proxy
    restart: unless-stopped
    volumes:
      - ${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock:ro
    environment:
      - CONTAINERS=1   # Allow listing containers
      - POST=1         # Allow some POST requests (needed for exec/restart)
      - EXEC=1         # Allow executing commands (for setup scripts)
      - INFO=1         # Allow info check
    networks:
      - mail-network

  # MySQL Database
  mysql:
    image: docker.io/library/mysql:8.0
    container_name: mail-mysql
    restart: unless-stopped
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: mailadmin
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d:ro
      - ./backup-scripts:/backup-scripts
    networks:
      - mail-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Redis
  redis:
    image: docker.io/library/redis:7-alpine
    container_name: mail-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./data/redis:/data
    networks:
      - mail-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    build: ./nginx
    image: localhost/email-server/nginx:latest
    container_name: mail-nginx
    restart: unless-stopped
    ports:
      # Rootless Podman cannot bind <1024; override via .env if needed.
      - "${HTTP_PORT:-8080}:80"
      - "${HTTPS_PORT:-8443}:443"
    volumes:
      - ./data/nginx/www:/var/www/html
      # Needed so $realpath_root and try_files can resolve /public/index.php
      - ./symfony-dashboard/public:/var/www/html/public:ro
      - ./certificates:/etc/letsencrypt
    environment:
      - DOMAIN=${DOMAIN}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
    networks:
      - mail-network
    depends_on:
      - symfony-dashboard
      - mailserver
      # - horde  <-- Uncomment this only after Horde is working

  # Horde Webmail
  horde:
    profiles:
      - webmail
    # switched to a community image because official horde/horde is private/missing
    image: docker.io/tkoerner/horde:latest
    container_name: mail-horde
    restart: unless-stopped
    environment:
      - DB_DRIVER=mysqli
      # Horde uses its own DB credentials (separate from dashboard DB user/admin login)
      - DB_USER=${HORDE_DB_USER}
      - DB_PASS=${HORDE_DB_PASSWORD}
      - DB_HOST=mysql
      - DB_NAME=${HORDE_DB_NAME:-horde}
      # DB admin for initial schema setup (use same dedicated Horde DB user)
      - HORDEDB_ADMIN_USER=${HORDE_DB_USER}
      - HORDEDB_ADMIN_PASS=${HORDE_DB_PASSWORD}
    networks:
      - mail-network
    depends_on:
      - mysql
      - mailserver

  # Docker Mailserver
  mailserver:
    container_name: mailserver
    # docker-mailserver requires a fully-qualified hostname; podman-compose may not apply `domainname:`.
    hostname: mail.${DOMAIN}
    restart: unless-stopped
    image: docker.io/mailserver/docker-mailserver:latest
    ports:
      # Rootless Podman cannot bind <1024; override via .env if needed.
      - "${SMTP_PORT:-1025}:25"
      - "${SUBMISSION_PORT:-1587}:587"
      - "${SMTPS_PORT:-1465}:465"
      - "${IMAP_PORT:-1143}:143"
      - "${IMAPS_PORT:-1993}:993"
      - "${POP3_PORT:-1110}:110"
      - "${POP3S_PORT:-1995}:995"
    volumes:
      - ./data/mailserver/mail-data:/var/mail
      - ./data/mailserver/mail-state:/var/mail-state
      - ./data/mailserver/mail-logs:/var/log/mail
      - ./data/mailserver/config:/tmp/docker-mailserver
      - ./certificates:/etc/letsencrypt
      - /etc/localtime:/etc/localtime:ro
    environment:
      - ENABLE_MANAGESIEVE=yes
      # For localhost development, set MAILSERVER_SSL_TYPE=none in .env to avoid certificate generation.
      - SSL_TYPE=${MAILSERVER_SSL_TYPE:-letsencrypt}
      - PERMIT_DOCKER=network
      - SPOOF_PROTECTION=1
    cap_add:
      - SYS_PTRACE
    networks:
      - mail-network
    healthcheck:
      test: "ss --listening --tcp | grep -P 'LISTEN.+:smtp' || exit 1"
      start_period: 60s

  # Certbot (Disable for localhost development)
  certbot:
    profiles:
      - letsencrypt
    image: docker.io/certbot/certbot:latest
    container_name: mail-certbot
    volumes:
      - ./certificates:/etc/letsencrypt
      - ./data/nginx/www:/var/www/html
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - mail-network
    depends_on:
      - nginx

networks:
  mail-network:
    driver: bridge