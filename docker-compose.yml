services:
  # Symfony Dashboard
  symfony-dashboard:
    build: ./symfony-dashboard
    image: localhost/email-server/dashboard:latest
    container_name: mail-dashboard
    restart: unless-stopped
    volumes:
      - ./data/dashboard/uploads:/var/www/html/public/uploads
      - ./data/dashboard/backups:/var/www/html/var/backups
      - ./certificates:/var/www/html/var/certificates
    environment:
      - DOCKER_HOST=tcp://socket-proxy:2375
      - DATABASE_URL=mysql://mailadmin:${MYSQL_PASSWORD}@mysql/mail_dashboard
      - MAIL_SERVER_HOST=mailserver
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - APP_ENV=prod
      - APP_SECRET=${APP_SECRET}
      - MAILER_DSN=smtp://mailserver:587
      - HORDE_URL=https://${DOMAIN}/webmail
      - VIRTUAL_HOST=${DOMAIN}
      - LETSENCRYPT_HOST=${DOMAIN}
      - LETSENCRYPT_EMAIL=${ADMIN_EMAIL}
    networks:
      - mail-network
    depends_on:
      - mysql
      - redis
      - socket-proxy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Socket Proxy (Security Layer)
  socket-proxy:
    image: docker.io/tecnativa/docker-socket-proxy
    container_name: mail-socket-proxy
    restart: unless-stopped
    volumes:
      - ${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock:ro
    environment:
      - CONTAINERS=1   # Allow listing containers
      - POST=1         # Allow some POST requests (needed for exec/restart)
      - EXEC=1         # Allow executing commands (for setup scripts)
      - INFO=1         # Allow info check
    networks:
      - mail-network

  # MySQL Database
  mysql:
    image: docker.io/library/mysql:8.0
    container_name: mail-mysql
    restart: unless-stopped
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: mail_dashboard
      MYSQL_USER: mailadmin
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./backup-scripts:/backup-scripts
    networks:
      - mail-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Redis
  redis:
    image: docker.io/library/redis:7-alpine
    container_name: mail-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./data/redis:/data
    networks:
      - mail-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    build: ./nginx
    image: localhost/email-server/nginx:latest
    container_name: mail-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./data/nginx/www:/var/www/html
      - ./certificates:/etc/letsencrypt
    environment:
      - ADMIN_EMAIL=${ADMIN_EMAIL}
    networks:
      - mail-network
    depends_on:
      - symfony-dashboard
      - mailserver
      # - horde  <-- Uncomment this only after Horde is working

  # Horde Webmail
  horde:
    # switched to a community image because official horde/horde is private/missing
    image: docker.io/tkoerner/horde:latest
    container_name: mail-horde
    restart: unless-stopped
    environment:
      - DB_DRIVER=mysqli
      - DB_USER=mailadmin
      - DB_PASS=${MYSQL_PASSWORD}
      - DB_HOST=mysql
      - DB_NAME=horde
      - HORDEDB_ADMIN_USER=admin
      - HORDEDB_ADMIN_PASS=${MYSQL_PASSWORD}
    networks:
      - mail-network
    depends_on:
      - mysql
      - mailserver

  # Docker Mailserver
  mailserver:
    container_name: mailserver
    hostname: mail
    domainname: ${DOMAIN}
    restart: unless-stopped
    image: docker.io/mailserver/docker-mailserver:latest
    ports:
      - "25:25"
      - "587:587"
      - "465:465"
      - "143:143"
      - "993:993"
      - "110:110"
      - "995:995"
    volumes:
      - ./data/mail/mail-data:/var/mail
      - ./data/mail/mail-state:/var/mail-state
      - ./data/mail/mail-logs:/var/log/mail
      - ./data/mail/config:/tmp/docker-mailserver
      - ./certificates:/etc/letsencrypt
      - /etc/localtime:/etc/localtime:ro
    environment:
      - ENABLE_MANAGESIEVE=yes
      - SSL_TYPE=letsencrypt
      - PERMIT_DOCKER=network
      - SPOOF_PROTECTION=1
    cap_add:
      - SYS_PTRACE
    networks:
      - mail-network
    healthcheck:
      test: "ss --listening --tcp | grep -P 'LISTEN.+:smtp' || exit 1"
      start_period: 60s

  # Certbot (Disable for localhost development)
  certbot:
    image: docker.io/certbot/certbot:latest
    container_name: mail-certbot
    volumes:
      - ./certificates:/etc/letsencrypt
      - ./data/nginx/www:/var/www/html
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - mail-network
    depends_on:
      - nginx

networks:
  mail-network:
    driver: bridge